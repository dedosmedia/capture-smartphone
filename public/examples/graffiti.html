<!DOCTYPE html>
<html>
<head>
	<title>Example: Paint</title>
</head>
<body>

	<canvas height=768 width=1024></canvas>
	<div class="container" style="position:absolute;left:0;top:0;width:768px;height:1024px;"></div>
	<script src="/javascripts/lib/require.2.1.1.js"></script>
	<script>
	requirejs.config({
	  baseUrl:'/javascripts',
	  paths:{
	    socketio:'/socket.io/socket.io',
	    ws:'helpers/ws',
	    event2socket:'helpers/event2socket'
	  },
	  shim:{
	    'ws':['socketio']
	  }
	});

	require([
	  'helpers/socket2event', 
	  'ws'
		], function(devices, ws){
			var c=document.querySelector('canvas'), ctx=c.getContext('2d');
			
			ctx.lineWidth=25;
			ctx.lineCap = 'round';

			function putCircle(coords, color){
				ctx.fillStyle = color;
				ctx.beginPath();
				ctx.arc(coords.x, coords.y, 10, 0, Math.PI*2, true);
				ctx.closePath();
				ctx.fill();
			}

			function line(from, to, color){
				ctx.strokeStyle = color;
				ctx.beginPath();
				ctx.moveTo(from.x, from.y)
				ctx.lineTo(to.x, to.y);
				ctx.stroke();
			}
			
			var painters={}; // 1D list of id:s generated using device_id+finger_id

			ws.on('client connected', function(e){
				console.log('client connected');
			});
			
			devices.addEventListener('touchstart', function(e){
				var t, o;
				if(e.targetTouches.length!==2){
			    for(var i=0; i<e.targetTouches.length; i++){
						t=e.targetTouches[i];
						o={x:t.clientX,y:t.clientY};
						painters[e.id+'_'+i]=o;
						putCircle(o, e.color);
			    }
				} else { // swipe detected, move!
					console.log('moving...');
				}

		  });
		  devices.addEventListener('touchmove', function(e){
				var t;
				if(e.targetTouches.length!==2){
			    for(var i=0; i<e.targetTouches.length; i++){
						t=e.targetTouches[i];
						o={x:t.clientX,y:t.clientY};
						line(painters[e.id+'_'+i], o, e.color);
						painters[e.id+'_'+i]=o;
			    }
				} else { // swipe detected, move!
					console.log('moving...');
					var t=e.targetTouches[0], o={x:t.clientX,y:t.clientY};
					var el=document.querySelector('[data-socketid="device_'+e.id+'"]');
					//el.style.webkitTransform = 'translate3d('+o.x+'px,'+o.y+'px,0)'
				}
		  });
		  devices.addEventListener('touchend', function(e){
		  });
			devices.addEventListener('deviceinfo', function(e){
				console.log('deviceinfo');
				console.log(e);
				// make a box this size with alpha transparency
				var el=document.createElement('div');
				el.innerHTML = '<section class="player" data-socketid="device_'+
					e.id+
					'" style="position:absolute;left:0;top:0;'+
					'width:'+e.width+'px;'+
					'height:'+e.height+'px;'+
					'background-color:'+e.color.replace('1)','0.15)')+';'+
					'border:1px solid '+e.color+'"></div>';
				document.querySelector('.container').appendChild(el.querySelector('section'));
		  });
			ws.emit('join','displays');
		});
	
	</script>
</body>
</html>